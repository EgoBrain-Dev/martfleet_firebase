<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrar - MartFleet</title>
    
    <!-- CSS específico da página será carregado dinamicamente -->
</head>
<body>
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div class="max-w-6xl w-full grid grid-cols-1 lg:grid-cols-2 bg-white rounded-3xl shadow-2xl overflow-hidden">
            
            <!-- Left Panel - Branding -->
            <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-8 lg:p-12 relative overflow-hidden">
                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,<svg width=\"60\" height=\"60\" viewBox=\"0 0 60 60\" xmlns=\"http://www.w3.org/2000/svg\"><g fill=\"none\" fill-rule=\"evenodd\"><circle fill=\"%23ffffff\" cx=\"30\" cy=\"30\" r=\"1.5\"/></g></svg>');"></div>
                </div>
                
                <!-- Floating Elements -->
                <div class="absolute top-10 left-10 w-20 h-20 bg-white/10 rounded-full blur-xl animate-pulse"></div>
                <div class="absolute bottom-20 right-10 w-32 h-32 bg-blue-400/20 rounded-full blur-xl animate-pulse delay-1000"></div>
                <div class="absolute top-1/2 left-1/3 w-16 h-16 bg-green-400/20 rounded-full blur-lg animate-pulse delay-500"></div>
                
                <div class="relative z-10 h-full flex flex-col justify-center items-center text-center text-white">
                    <!-- Animated Logo -->
                    <div class="mb-8 relative">
                        <div class="relative w-24 h-24 mx-auto">
                            <!-- Outer Circles -->
                            <div class="absolute inset-0 border-2 border-white/30 rounded-full animate-ping"></div>
                            <div class="absolute inset-2 border-2 border-white/40 rounded-full animate-pulse delay-300"></div>
                            <div class="absolute inset-4 border-2 border-white/50 rounded-full animate-pulse delay-700"></div>
                            
                            <!-- Main Icon -->
                            <div class="absolute inset-0 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center border border-white/30">
                                <i class="fas fa-taxi text-2xl text-white"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Brand Content -->
                    <h1 class="text-4xl lg:text-5xl font-bold mb-4 bg-gradient-to-r from-white to-blue-100 bg-clip-text text-transparent">
                        MartFleet
                    </h1>
                    <p class="text-blue-100 text-lg mb-8 font-light">Gestão Inteligente</p>

                    <!-- Features List -->
                    <div class="space-y-4 max-w-sm">
                        <div class="flex items-center justify-center space-x-3 p-3 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 transition-all duration-300 hover:bg-white/20 hover:scale-105">
                            <i class="fas fa-shield-alt text-blue-200"></i>
                            <span class="text-sm font-medium">Plataforma 100% Segura</span>
                        </div>
                        <div class="flex items-center justify-center space-x-3 p-3 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 transition-all duration-300 hover:bg-white/20 hover:scale-105">
                            <i class="fas fa-bolt text-yellow-200"></i>
                            <span class="text-sm font-medium">Performance Otimizada</span>
                        </div>
                        <div class="flex items-center justify-center space-x-3 p-3 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20 transition-all duration-300 hover:bg-white/20 hover:scale-105">
                            <i class="fas fa-chart-line text-green-200"></i>
                            <span class="text-sm font-medium">Relatórios em Tempo Real</span>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="mt-12 grid grid-cols-3 gap-8 text-center">
                        <div>
                            <div class="text-2xl font-bold text-white">150+</div>
                            <div class="text-blue-200 text-xs uppercase tracking-wider">Veículos</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white">500+</div>
                            <div class="text-blue-200 text-xs uppercase tracking-wider">Motoristas</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white">98%</div>
                            <div class="text-blue-200 text-xs uppercase tracking-wider">Satisfação</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Login Form -->
            <div class="p-8 lg:p-12 flex items-center justify-center">
                <div class="w-full max-w-md">
                    <!-- Form Header -->
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Bem-vindo de Volta</h2>
                        <p class="text-gray-600">Entre na sua conta para continuar</p>
                    </div>

                    <!-- Login Form -->
                    <form class="space-y-6" id="loginForm">
                        <!-- Email Field -->
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope text-blue-500 mr-2"></i>
                                Email
                            </label>
                            <div class="relative">
                                <input 
                                    type="email" 
                                    id="email" 
                                    name="email"
                                    class="w-full px-4 py-3 pl-11 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                                    placeholder="seu@email.com"
                                    required
                                >
                                <i class="fas fa-envelope absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <i id="emailValidIcon" class="fas fa-check-circle absolute right-4 top-1/2 transform -translate-y-1/2 text-green-500 opacity-0 transition-opacity duration-200"></i>
                                <i id="emailErrorIcon" class="fas fa-exclamation-circle absolute right-4 top-1/2 transform -translate-y-1/2 text-red-500 opacity-0 transition-opacity duration-200"></i>
                            </div>
                            <div id="emailError" class="mt-2 text-sm text-red-600 opacity-0 transition-opacity duration-200"></div>
                        </div>

                        <!-- Password Field -->
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label for="password" class="block text-sm font-medium text-gray-700">
                                    <i class="fas fa-lock text-blue-500 mr-2"></i>
                                    Palavra-passe
                                </label>
                                <a href="#" data-spa="forgot-password" data-page="forgot-password" class="text-sm text-blue-600 hover:text-blue-500 transition-colors duration-200">
                                    Esqueceu a senha?
                                </a>
                            </div>
                            <div class="relative">
                                <input 
                                    type="password" 
                                    id="password" 
                                    name="password"
                                    class="w-full px-4 py-3 pl-11 pr-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                                    placeholder="Sua palavra-passe"
                                    required
                                >
                                <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <button type="button" id="passwordToggle" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <i id="passwordValidIcon" class="fas fa-check-circle absolute right-12 top-1/2 transform -translate-y-1/2 text-green-500 opacity-0 transition-opacity duration-200"></i>
                                <i id="passwordErrorIcon" class="fas fa-exclamation-circle absolute right-12 top-1/2 transform -translate-y-1/2 text-red-500 opacity-0 transition-opacity duration-200"></i>
                            </div>
                            <div id="passwordError" class="mt-2 text-sm text-red-600 opacity-0 transition-opacity duration-200"></div>
                        </div>

                        <!-- Remember Me -->
                        <div class="flex items-center">
                            <input 
                                type="checkbox" 
                                id="remember" 
                                name="remember"
                                class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                            >
                            <label for="remember" class="ml-2 text-sm text-gray-700">
                                Lembrar-me
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button 
                            type="submit" 
                            id="submitBtn"
                            class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-4 px-6 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        >
                            <span id="btnText">Entrar na Conta</span>
                            <div id="btnLoading" class="hidden items-center justify-center space-x-2">
                                <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                <span>Autenticando...</span>
                            </div>
                        </button>
                    </form>

                    <!-- Divider -->
                    <div class="my-8 flex items-center">
                        <div class="flex-1 border-t border-gray-300"></div>
                        <div class="px-4 text-sm text-gray-500">ou</div>
                        <div class="flex-1 border-t border-gray-300"></div>
                    </div>

                    <!-- Alternative Actions -->
                    <div class="text-center space-y-4">
                        <p class="text-gray-600 text-sm">
                            Não tem uma conta? 
                            <a href="#" data-spa="register" data-page="register" class="text-blue-600 font-semibold hover:text-blue-500 transition-colors duration-200">
                                Criar conta gratuita
                            </a>
                        </p>
                        <div class="flex justify-center space-x-4">
                            <a href="#" data-spa="register-owner" data-page="register-owner" class="text-sm text-green-600 hover:text-green-500 transition-colors duration-200 font-medium">
                                <i class="fas fa-building mr-1"></i>Sou Dono
                            </a>
                            <a href="#" data-spa="register-driver" data-page="register-driver" class="text-sm text-purple-600 hover:text-purple-500 transition-colors duration-200 font-medium">
                                <i class="fas fa-id-card mr-1"></i>Sou Motorista
                            </a>
                        </div>
                    </div>

                    <!-- Security Badge -->
                    <div class="mt-8 flex items-center justify-center space-x-2 p-4 bg-gray-50 rounded-xl border border-gray-200">
                        <i class="fas fa-shield-check text-green-500"></i>
                        <span class="text-sm text-gray-600">Conexão segura • SSL Encriptado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicialização do formulário de login
        document.addEventListener('DOMContentLoaded', function() {
            initializeLoginForm();
        });

        function initializeLoginForm() {
            const loginForm = document.getElementById('loginForm');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const passwordToggle = document.getElementById('passwordToggle');
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');

            // Toggle de visibilidade da senha
            passwordToggle.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });

            // Validação em tempo real do email
            emailInput.addEventListener('input', function() {
                validateEmailField(this.value);
            });

            // Validação em tempo real da senha
            passwordInput.addEventListener('input', function() {
                validatePasswordField(this.value);
            });

            // Submissão do formulário
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (await validateForm()) {
                    await handleLogin();
                }
            });

            // Validação do campo email
            function validateEmailField(email) {
                const emailValidIcon = document.getElementById('emailValidIcon');
                const emailErrorIcon = document.getElementById('emailErrorIcon');
                const emailError = document.getElementById('emailError');

                if (!email) {
                    resetFieldValidation(emailValidIcon, emailErrorIcon, emailError);
                    return false;
                }

                if (MartFleetUtils.Validators.email(email)) {
                    showFieldValid(emailValidIcon, emailErrorIcon, emailError);
                    return true;
                } else {
                    showFieldError(emailValidIcon, emailErrorIcon, emailError, 'Email inválido');
                    return false;
                }
            }

            // Validação do campo senha
            function validatePasswordField(password) {
                const passwordValidIcon = document.getElementById('passwordValidIcon');
                const passwordErrorIcon = document.getElementById('passwordErrorIcon');
                const passwordError = document.getElementById('passwordError');

                if (!password) {
                    resetFieldValidation(passwordValidIcon, passwordErrorIcon, passwordError);
                    return false;
                }

                if (password.length >= 6) {
                    showFieldValid(passwordValidIcon, passwordErrorIcon, passwordError);
                    return true;
                } else {
                    showFieldError(passwordValidIcon, passwordErrorIcon, passwordError, 'A senha deve ter pelo menos 6 caracteres');
                    return false;
                }
            }

            // Validação completa do formulário
            async function validateForm() {
                const isEmailValid = validateEmailField(emailInput.value);
                const isPasswordValid = validatePasswordField(passwordInput.value);

                return isEmailValid && isPasswordValid;
            }

            // Funções auxiliares de validação visual
            function showFieldValid(validIcon, errorIcon, errorElement) {
                validIcon.classList.remove('opacity-0');
                errorIcon.classList.add('opacity-0');
                errorElement.classList.add('opacity-0');
            }

            function showFieldError(validIcon, errorIcon, errorElement, message) {
                validIcon.classList.add('opacity-0');
                errorIcon.classList.remove('opacity-0');
                errorElement.textContent = message;
                errorElement.classList.remove('opacity-0');
            }

            function resetFieldValidation(validIcon, errorIcon, errorElement) {
                validIcon.classList.add('opacity-0');
                errorIcon.classList.add('opacity-0');
                errorElement.classList.add('opacity-0');
            }

            // Processamento do login
            async function handleLogin() {
                try {
                    // Mostra estado de loading
                    setLoadingState(true);

                    const email = emailInput.value;
                    const password = passwordInput.value;
                    const rememberMe = document.getElementById('remember').checked;

                    // Configura persistência baseado no "Lembrar-me"
                    const persistence = rememberMe ? 
                        firebase.auth.Auth.Persistence.LOCAL : 
                        firebase.auth.Auth.Persistence.SESSION;

                    await firebase.auth().setPersistence(persistence);

                    // Realiza o login
                    const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // Verifica se o email foi verificado
                    if (!user.emailVerified) {
                        MartFleetUtils.NotificationSystem.warning(
                            'Por favor, verifique seu email antes de continuar. ' +
                            '<a href="#" onclick="resendVerificationEmail()" class="underline">Reenviar verificação</a>',
                            6000
                        );
                    }

                    // Login bem sucedido
                    MartFleetUtils.NotificationSystem.success('Login realizado com sucesso!');
                    
                    // Redireciona baseado no role do usuário
                    setTimeout(() => {
                        redirectAfterLogin();
                    }, 1000);

                } catch (error) {
                    handleLoginError(error);
                } finally {
                    setLoadingState(false);
                }
            }

            function setLoadingState(isLoading) {
                if (isLoading) {
                    submitBtn.disabled = true;
                    btnText.classList.add('hidden');
                    btnLoading.classList.remove('hidden');
                } else {
                    submitBtn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            }

            function handleLoginError(error) {
                console.error('Erro no login:', error);
                
                let errorMessage = 'Erro ao fazer login. Tente novamente.';
                
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'Esta conta foi desativada.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage = 'Nenhuma conta encontrada com este email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Senha incorreta.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Muitas tentativas de login. Tente novamente mais tarde.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Erro de conexão. Verifique sua internet.';
                        break;
                }
                
                MartFleetUtils.NotificationSystem.error(errorMessage);
            }

            function redirectAfterLogin() {
                // Usa a função de navegação do sistema SPA
                if (window.MartFleetApp.userRole === 'owner') {
                    window.MartFleet.navigateWithAuthCheck('owner-dashboard', '/templates/owner/dashboard.html', 'owner');
                } else if (window.MartFleetApp.userRole === 'driver') {
                    window.MartFleet.navigateWithAuthCheck('driver-dashboard', '/templates/driver/dashboard.html', 'driver');
                } else {
                    // Role não definido, vai para página inicial
                    window.loadPage('/templates/index.html');
                }
            }
        }

        // Função global para reenviar email de verificação
        window.resendVerificationEmail = async function() {
            try {
                const user = firebase.auth().currentUser;
                if (user) {
                    await user.sendEmailVerification();
                    MartFleetUtils.NotificationSystem.success('Email de verificação reenviado!');
                }
            } catch (error) {
                console.error('Erro ao reenviar verificação:', error);
                MartFleetUtils.NotificationSystem.error('Erro ao reenviar email de verificação');
            }
        };
    </script>
</body>
</html>